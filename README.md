# lab7 lock
 
lab7主要要设计一些降低锁的颗粒度的策略，提高程序的并发速度。主要有两个任务，内存分配器以及Buffer cache

* CPU的内存分配器 `kernel/kalloc.c` 在xv6中，空闲内存由一个链表freelist维护，且由一把锁维护。这样在同一时间内只能有一个CPU来分配内存，并发速度非常低。

    1.针对以上问题，可以想到的是为每个CPU都分配一把锁，一个freelist，这样就可以大幅提高并发速度
    
    2.接下来要考虑的问题就是当某个CPU的freelist用完的情况，它需要去其他的freelist上偷一块空闲内存回来

    3.但是偷的时候可能会产生死锁的问题。假设CPUA、CPUB打算互相偷对方的，那么就产生了死锁，所以这里还需要再加一把大锁，保证每次只会有1个偷行为。

* BufferCache `kernel/bio.c` 多个进程同时使用文件系统时，bcache.lock上会发生严重的锁竞争。bcache.lock用于保护磁盘区块缓存，由于只有一把锁，多个进程不能同时操作磁盘缓存

    1.原版设计中，bcache是以双向链表组织的，每次取一个block都会加锁遍历链表
    
    2.可以建立一个从blockno到buf的哈希表，将原有的双向链表分成若干个哈希桶，并为每个桶单独加锁，这样就大幅提高了并发速度

    3.但是当发生cache missing的时候可能会引起死锁问题，假设两个CPU进行bget时都发生了cache missing，开始基于LRU驱逐缓存，遍历到互相的桶的时候，互相获取对方桶的锁，就发生了死锁。同理我们再引入一把大锁，保证只有一个会处理cache missing的情况
